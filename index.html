<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONSTRUCTION RENTAL MANAGER PRO + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .pipeline-scroll::-webkit-scrollbar { height: 4px; }
        .pipeline-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* ë‹¨ê³„ë³„ ìƒ‰ìƒ ì •ì˜ */
        .step-ì˜ì—… { border-left-color: #fbbf24; }
        .step-ë„ë©´ìˆ˜ë ¹ { border-left-color: #f59e0b; }
        .step-ë„ë©´ì‘ì—… { border-left-color: #3b82f6; }
        .step-ê²¬ì  { border-left-color: #6366f1; }
        .step-ê³„ì•½ { border-left-color: #10b981; }
        .step-ìì¬íˆ¬ì… { border-left-color: #ef4444; }
        .step-ê¸°ì„±ì •ë¦¬ { border-left-color: #8b5cf6; }
        .step-ìì¬ë°˜ë‚© { border-left-color: #64748b; }
        .step-ì •ì‚° { border-left-color: #0f172a; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ë° ì˜¤ë²„ë ˆì´ ì°¨ë‹¨ í•´ì œ */
        #auth-loading { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-enter { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-active { transform: translateY(0); }

        /* í´ë¦­ ê°€ëŠ¥ ìš”ì†Œ ë° í„°ì¹˜ ì˜ì—­ í™•ë³´ */
        .clickable { cursor: pointer; position: relative; z-index: 50; isolation: isolate; }
        .clickable:active { transform: scale(0.92); }
        
        /* í•˜ë‹¨ ë°” í„°ì¹˜ ê°„ì„­ ë°©ì§€ */
        nav { pointer-events: none; }
        nav > div { pointer-events: auto; }
    </style>
</head>
<body class="min-h-screen pb-40"> 

<!-- ì¸ì¦ ì „ í™”ë©´ ê°€ë¦¼ë§‰ -->
<div id="auth-loading">
    <div class="loader mb-4"></div>
    <p class="text-sm font-bold text-gray-500">Connecting to Database...</p>
</div>

<div id="app" class="max-w-2xl mx-auto hidden opacity-0 transition-opacity duration-300">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 px-6 py-5 sticky top-0 z-40">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-extrabold tracking-tight text-slate-900 uppercase">Rental Manager</h1>
                <p id="today-display" class="text-[11px] text-blue-600 font-bold mt-0.5 tracking-tighter"></p>
            </div>
            <div class="flex items-center gap-3">
                <!-- í˜„ì¥ ì¶”ê°€ ë²„íŠ¼ (í—¤ë”) -->
                <button onclick="window.openAddSite()" class="clickable bg-slate-900 text-white p-2.5 rounded-xl shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Viewport -->
    <main id="viewport" class="p-5 space-y-6"></main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-[60] pb-6 px-6">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-xl border border-gray-100 rounded-3xl shadow-2xl flex justify-between items-center px-8 py-4 relative">
            <button onclick="window.nav('dashboard')" class="nav-btn flex flex-col items-center gap-1 transition-colors" data-id="dashboard">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-[9px] font-bold">í™ˆ</span>
            </button>
            <button onclick="window.nav('pipeline')" class="nav-btn flex flex-col items-center gap-1 transition-colors text-gray-400" data-id="pipeline">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span class="text-[9px] font-bold">ê³µì •</span>
            </button>
            
            <!-- ë¡œê·¸ ì‘ì„± í”Œë¡œíŒ… ë²„íŠ¼ -->
            <button onclick="window.openLogForm()" class="clickable bg-indigo-600 text-white p-4 rounded-2xl shadow-xl shadow-indigo-200 -mt-12 border-4 border-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
            </button>

            <button onclick="window.nav('sites')" class="nav-btn flex flex-col items-center gap-1 transition-colors text-gray-400" data-id="sites">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-[9px] font-bold">í˜„ì¥</span>
            </button>
            <button onclick="window.render()" class="nav-btn flex flex-col items-center gap-1 transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                <span class="text-[9px] font-bold">ìƒˆë¡œê³ ì¹¨</span>
            </button>
        </div>
    </nav>

    <!-- Modal System -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-container" class="bg-white w-full max-w-lg rounded-t-[2.5rem] sm:rounded-3xl overflow-hidden shadow-2xl modal-enter">
            <div class="px-6 py-5 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                <h3 id="modal-title" class="font-extrabold text-slate-800 tracking-tight"></h3>
                <button onclick="window.closeModal()" class="text-slate-400 p-2 hover:bg-gray-100 rounded-full transition-colors">âœ•</button>
            </div>
            <div id="modal-body" class="p-6 max-h-[80vh] overflow-y-auto"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : "construction-rental-v1";
    const apiKey = ""; 

    const STEPS = ["ì˜ì—…", "ë„ë©´ìˆ˜ë ¹", "ë„ë©´ì‘ì—…", "ê²¬ì ", "ê³„ì•½", "ìì¬íˆ¬ì…", "ê¸°ì„±ì •ë¦¬", "ìì¬ë°˜ë‚©", "ì •ì‚°"];
    window.state = { user: null, view: 'dashboard', sites: [], logs: [], initialized: false };

    async function callGemini(prompt, systemPrompt = "") {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };
        try {
            const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await resp.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "ë¶„ì„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        } catch (e) { return "AI ì—°ê²° ì¼ì‹œì  ì¥ì• "; }
    }

    // AUTH LOGIC (RULE 3)
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.state.user = user;
            
            // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œê±° (í´ë¦­ ì°¨ë‹¨ í•´ì œ)
            const loader = document.getElementById('auth-loading');
            const appEl = document.getElementById('app');
            if(loader) {
                loader.style.display = 'none'; // DOMì—ì„œ ì¦‰ì‹œ ì œê±°
            }
            if(appEl) {
                appEl.classList.remove('hidden');
                setTimeout(() => appEl.classList.add('opacity-100'), 50);
            }
            
            const dateDisplay = document.getElementById('today-display');
            if(dateDisplay) dateDisplay.innerText = new Date().toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' });
            
            initSync();
        }
    });

    function initSync() {
        if (window.state.initialized || !window.state.user) return;
        
        // RULE 1: Strict Paths
        const sitesRef = collection(db, 'artifacts', appId, 'public', 'data', 'sites');
        const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'logs');

        onSnapshot(sitesRef, (snap) => {
            window.state.sites = snap.docs.map(d => d.data()).sort((a,b) => b.createdAt - a.createdAt);
            render();
        }, (err) => console.error("Sites Sync Error:", err));

        onSnapshot(logsRef, (snap) => {
            window.state.logs = snap.docs.map(d => d.data()).sort((a,b) => b.createdAt - a.createdAt);
            render();
        }, (err) => console.error("Logs Sync Error:", err));

        window.state.initialized = true;
    }

    window.nav = (v, id = null) => {
        window.state.view = v;
        window.state.activeId = id;
        render();
    };

    window.render = () => {
        const vp = document.getElementById('viewport');
        const view = window.state.view;
        if (!vp) return;

        document.querySelectorAll('.nav-btn').forEach(btn => {
            const active = btn.dataset.id === view;
            btn.classList.toggle('text-indigo-600', active);
            btn.classList.toggle('text-gray-400', !active);
        });

        if (view === 'dashboard') renderDashboard(vp);
        else if (view === 'pipeline') renderPipeline(vp);
        else if (view === 'sites') renderSiteList(vp);
        else if (view === 'site-detail') renderSiteDetail(vp);
    }

    function renderDashboard(el) {
        const logs = window.state.logs.slice(0, 5);
        const activeCount = window.state.sites.filter(s => s.step !== 'ì •ì‚°').length;
        const todayStr = new Date().toLocaleDateString('ko-KR');

        el.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-indigo-600 p-6 rounded-[2rem] text-white shadow-xl shadow-indigo-100">
                    <p class="text-[10px] font-bold opacity-70 uppercase tracking-widest">Active Sites</p>
                    <p class="text-3xl font-black mt-1">${activeCount}</p>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Today Logs</p>
                    <p class="text-3xl font-black mt-1 text-slate-800">${window.state.logs.filter(l => l.date === todayStr).length}</p>
                </div>
            </div>
            
            <section class="bg-slate-900 p-6 rounded-[2rem] text-white">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">ğŸ¤–</span>
                    <h3 class="text-xs font-black text-indigo-300 uppercase tracking-wider">AI Report</h3>
                </div>
                <p id="ai-dashboard-summary" class="text-[12px] font-medium leading-relaxed text-slate-300">ì—…ë¬´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </section>

            <section class="space-y-4">
                <h3 class="text-sm font-black text-slate-800 px-1">ìµœê·¼ ì—…ë¬´ íˆìŠ¤í† ë¦¬</h3>
                ${logs.map(l => `
                    <div onclick="window.nav('site-detail', '${l.siteId}')" class="clickable bg-white p-5 rounded-3xl border-l-8 step-${l.cat} shadow-sm border border-slate-50 transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-black text-slate-400 uppercase truncate max-w-[140px]">${l.siteName}</span>
                            <span class="text-[9px] font-black px-2 py-0.5 rounded bg-slate-50 text-slate-500 border border-slate-100">${l.cat}</span>
                        </div>
                        <p class="text-[14px] font-bold text-slate-700 leading-snug">${l.content}</p>
                        <p class="text-[9px] text-slate-300 font-bold mt-3 uppercase tracking-tighter">${l.date}</p>
                    </div>
                `).join('') || `<div class="py-20 text-center text-xs text-slate-300 font-bold italic">ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
            </section>
        `;
        updateDashboardSummary();
    }

    async function updateDashboardSummary() {
        const container = document.getElementById('ai-dashboard-summary');
        if (!container || window.state.logs.length === 0) return;
        const recentLogs = window.state.logs.slice(0, 10).map(l => `[${l.siteName}] ${l.content}`).join('\n');
        const summary = await callGemini(recentLogs, "ê±´ì„¤ ë¹„ì„œë¡œì„œ ì˜¤ëŠ˜ ì£¼ìš” ìƒí™©ì„ 100ì ë‚´ ìš”ì•½í•´ì¤˜.");
        if (container) container.innerText = summary;
    }

    function renderPipeline(el) {
        el.innerHTML = `
            <h3 class="text-sm font-black text-slate-800 mb-6 px-1 uppercase tracking-tight">Status Pipeline</h3>
            <div class="space-y-8">
                ${STEPS.map(step => {
                    const stepSites = window.state.sites.filter(s => (s.step || 'ì˜ì—…') === step);
                    return `
                        <div>
                            <div class="flex justify-between items-center mb-3 px-1 border-l-4 border-slate-200 pl-3">
                                <span class="text-xs font-extrabold text-slate-700">${step}</span>
                                <span class="text-[10px] font-black bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full">${stepSites.length}</span>
                            </div>
                            <div class="flex flex-nowrap overflow-x-auto gap-4 pb-2 pipeline-scroll">
                                ${stepSites.map(s => `
                                    <div onclick="window.nav('site-detail', '${s.id}')" class="clickable shrink-0 bg-white border border-slate-100 p-5 rounded-2xl shadow-sm w-44 hover:border-indigo-200 transition-colors">
                                        <p class="text-xs font-black text-slate-800 truncate mb-1">${s.name}</p>
                                        <p class="text-[9px] font-bold text-slate-400 truncate">${s.company || 'ì—…ì²´ë¯¸ì§€ì •'}</p>
                                    </div>
                                `).join('') || '<div class="text-[10px] text-slate-200 font-bold py-2 px-1 italic">í˜„ì¥ ì—†ìŒ</div>'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function renderSiteList(el) {
        el.innerHTML = `
            <div class="flex justify-between items-center mb-6 px-1">
                <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest">Site Directory</h3>
            </div>
            <div class="grid gap-4">
                ${window.state.sites.map(s => `
                    <div onclick="window.nav('site-detail', '${s.id}')" class="clickable bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                        <div class="flex justify-between items-center">
                            <div class="max-w-[70%]">
                                <h4 class="font-black text-base text-slate-800 leading-tight">${s.name}</h4>
                                <p class="text-[10px] text-slate-400 font-bold mt-1 tracking-wider">${s.company || 'No Company Info'}</p>
                            </div>
                            <span class="text-[9px] font-black px-3 py-1.5 rounded-xl bg-indigo-50 text-indigo-600 uppercase border border-indigo-100">${s.step || 'ì˜ì—…'}</span>
                        </div>
                    </div>
                `).join('')}
                <button onclick="window.openAddSite()" class="clickable w-full py-12 border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-300 font-black text-xs bg-white/50 hover:bg-white hover:text-indigo-400 hover:border-indigo-200 transition-all">
                    + ADD NEW PROJECT
                </button>
            </div>
        `;
    }

    function renderSiteDetail(el) {
        const site = window.state.sites.find(s => s.id === window.state.activeId);
        if(!site) return window.nav('sites');
        const logs = window.state.logs.filter(l => l.siteId === site.id);

        el.innerHTML = `
            <div class="flex items-center gap-4 mb-6">
                <button onclick="window.nav('sites')" class="clickable bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-slate-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div>
                    <h2 class="font-black text-lg text-slate-800 leading-tight">${site.name}</h2>
                    <p class="text-[10px] font-bold text-slate-400">${site.company || 'ë°œì£¼ì²˜ ì •ë³´ ì—†ìŒ'}</p>
                </div>
            </div>

            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 p-6 rounded-[2.5rem] text-white shadow-xl mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-[10px] font-black uppercase tracking-widest opacity-80">Site Analysis</h4>
                    <span class="text-[9px] px-2 py-0.5 rounded-full bg-white/20 font-bold">AI PRO</span>
                </div>
                <div id="ai-site-analysis"><p class="text-[13px] font-bold italic opacity-60">ë°ì´í„° ë¶„ì„ì„ ìš”ì²­ ì¤‘...</p></div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm mb-8">
                <label class="text-[9px] font-black text-slate-300 uppercase block mb-4 tracking-widest text-center">Current Project Phase</label>
                <div class="grid grid-cols-3 gap-2">
                    ${STEPS.map(st => `
                        <button onclick="window.updateSiteStep('${site.id}', '${st}')" 
                                class="clickable py-3 rounded-2xl text-[10px] font-black transition-all border
                                ${site.step === st ? 'bg-slate-900 text-white border-slate-900 shadow-lg' : 'bg-slate-50 text-slate-300 border-slate-50'}">
                            ${st}
                        </button>
                    `).join('')}
                </div>
            </div>

            <section class="space-y-4">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight">Timeline</h3>
                    <button onclick="window.openLogForm('${site.id}')" class="clickable text-[11px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-2xl">+ LOG</button>
                </div>
                ${logs.map(l => `
                    <div class="bg-white p-5 rounded-3xl border border-slate-50 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] font-black px-2 py-0.5 rounded-md bg-slate-900 text-white uppercase">${l.cat}</span>
                            <span class="text-[9px] text-slate-300 font-extrabold uppercase">${l.date}</span>
                        </div>
                        <p class="text-[14px] font-bold text-slate-700 leading-relaxed">${l.content}</p>
                    </div>
                `).join('') || '<div class="text-center py-20 text-[11px] font-bold text-slate-300 italic">íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>'}
            </section>
        `;
        updateSiteAI(site, logs);
    }

    async function updateSiteAI(site, logs) {
        const analysisEl = document.getElementById('ai-site-analysis');
        if (!analysisEl || logs.length === 0) return;
        const logCtx = logs.map(l => l.content).join(', ');
        const summary = await callGemini(`í˜„ì¥:${site.name}, ë¡œê·¸:${logCtx}`, "ì´ í˜„ì¥ì˜ ë¦¬ìŠ¤í¬ì™€ í˜„í™©ì„ 80ì ë‚´ë¡œ ì „ë¬¸ê°€ì²˜ëŸ¼ ìš”ì•½í•´ì¤˜.");
        if(analysisEl) analysisEl.innerHTML = `<p class="text-[14px] font-bold leading-snug">${summary}</p>`;
    }

    window.openAddSite = () => {
        window.openModal('í˜„ì¥ ì‹ ê·œ ë“±ë¡', `
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-400 mb-2 block ml-1 uppercase">Site Name</label>
                    <input id="s-name" type="text" placeholder="ì˜ˆ: í•œê°• ìì´ ê³µì‚¬í˜„ì¥" class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 mb-2 block ml-1 uppercase">Client / Company</label>
                    <input id="s-company" type="text" placeholder="ì˜ˆ: (ì£¼)í˜„ëŒ€ê±´ì„¤" class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                </div>
                <button onclick="window.saveSite()" class="clickable w-full py-5 bg-slate-900 text-white rounded-3xl text-xs font-black uppercase tracking-[0.2em] shadow-2xl mt-4">Create Project</button>
            </div>
        `);
    };

    window.saveSite = async () => {
        if (!window.state.user) return;
        const name = document.getElementById('s-name').value.trim();
        if (!name) return;
        const id = 'S' + Date.now();
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sites', id), {
            id, name, company: document.getElementById('s-company').value,
            step: "ì˜ì—…", createdAt: Date.now()
        });
        window.closeModal();
    };

    window.updateSiteStep = async (id, step) => {
        if (!window.state.user) return;
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sites', id), { step });
    }

    window.openLogForm = (preSiteId = '') => {
        window.openModal('ì—…ë¬´ ë¡œê·¸ ì‘ì„±', `
            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block ml-1">í˜„ì¥ ì„ íƒ</label>
                        <select id="l-site" class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm font-bold outline-none appearance-none">
                            ${window.state.sites.map(s => `<option value="${s.id}" ${preSiteId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block ml-1">ê³µì • ë‹¨ê³„</label>
                        <select id="l-cat" class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm font-bold outline-none appearance-none">
                            ${STEPS.map(st => `<option>${st}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 mb-2 block ml-1 uppercase">Activity Details</label>
                    <textarea id="l-content" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ì—…ë¬´ê°€ ì§„í–‰ë˜ì—ˆë‚˜ìš”?" class="w-full p-5 rounded-2xl bg-slate-50 border-none text-sm font-bold h-40 outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                </div>
                <button onclick="window.saveLog()" class="clickable w-full py-5 bg-indigo-600 text-white rounded-3xl text-xs font-black uppercase tracking-[0.2em] shadow-xl shadow-indigo-100">Save Timeline</button>
            </div>
        `);
    };

    window.saveLog = async () => {
        if (!window.state.user) return;
        const siteId = document.getElementById('l-site').value;
        const content = document.getElementById('l-content').value.trim();
        if (!siteId || !content) return;
        
        const site = window.state.sites.find(s=>s.id === siteId);
        const cat = document.getElementById('l-cat').value;
        const id = 'L' + Date.now();
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', id), {
            id, siteId, siteName: site.name, cat,
            date: new Date().toLocaleDateString('ko-KR'), 
            createdAt: Date.now(), content
        });
        await window.updateSiteStep(siteId, cat);
        window.closeModal();
    };

    window.openModal = (title, html) => {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = html;
        const overlay = document.getElementById('modal-overlay');
        overlay.classList.remove('hidden');
        setTimeout(() => document.getElementById('modal-container').classList.add('modal-active'), 10);
    };

    window.closeModal = () => {
        document.getElementById('modal-container').classList.remove('modal-active');
        setTimeout(() => document.getElementById('modal-overlay').classList.add('hidden'), 300);
    };

    // ì´ˆê¸° ë Œë”ë§
    window.render();

</script>
</body>
</html>
