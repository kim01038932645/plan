<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Construction Sales Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .canvas-bg { background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .touch-target { min-height: 44px; min-width: 44px; }
        #sketch-canvas { cursor: crosshair; touch-action: none; background: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-50 relative">
    <!-- 상단 헤더 -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h1 class="text-xl font-black text-indigo-600 tracking-tighter">CSM PRO</h1>
        <div id="ai-status" class="flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-[10px] font-bold text-slate-400">GEMINI ACTIVE</span>
        </div>
    </header>

    <!-- 메인 뷰포트 -->
    <main id="viewport" class="flex-1 overflow-y-auto pb-32 px-4 pt-6 no-scrollbar"></main>

    <!-- 바텀 내비게이션 -->
    <nav class="fixed bottom-6 left-4 right-4 max-w-md mx-auto bg-slate-900/95 backdrop-blur-lg text-white rounded-[2.5rem] flex justify-around items-center py-4 shadow-2xl z-[100] border border-white/10">
        <button onclick="window.router.push('dashboard')" class="nav-item flex flex-col items-center gap-1 opacity-50" data-view="dashboard">
            <i data-lucide="layout-grid" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold">대시보드</span>
        </button>
        <button onclick="window.router.push('sites')" class="nav-item flex flex-col items-center gap-1 opacity-50" data-view="sites">
            <i data-lucide="building-2" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold">현장관리</span>
        </button>
        <button onclick="window.router.push('partners')" class="nav-item flex flex-col items-center gap-1 opacity-50" data-view="partners">
            <i data-lucide="users-round" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold">협력사</span>
        </button>
        <button onclick="window.askGeminiModal()" class="flex flex-col items-center gap-1 text-indigo-400">
            <i data-lucide="sparkles" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold">AI분석</span>
        </button>
    </nav>

    <!-- 모달 -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-end">
        <div id="modal-content" class="bg-white w-full max-h-[90vh] rounded-t-[2.5rem] overflow-hidden flex flex-col shadow-2xl transition-transform duration-300"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'construction-sales-csm';
    const apiKey = ""; // Gemini API Key

    window.state = {
        user: null,
        currentView: 'dashboard',
        activeId: null,
        sites: [],
        partners: [],
        logs: [],
        categories: ['신규발굴', '현장미팅', '견적제출', '계약체결', 'AS/사후']
    };

    // 라우팅 시스템
    window.router = {
        push: (view, id = null) => {
            window.state.currentView = view;
            window.state.activeId = id;
            window.renderView();
            window.updateNav();
        }
    };

    window.updateNav = () => {
        document.querySelectorAll('.nav-item').forEach(btn => {
            const isActive = btn.dataset.view === window.state.currentView || 
                            (window.state.currentView.includes('detail') && window.state.currentView.startsWith(btn.dataset.view.slice(0, -1)));
            btn.style.opacity = isActive ? "1" : "0.5";
            btn.classList.toggle('text-indigo-400', isActive);
        });
    };

    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    function initDataSync() {
        if (!window.state.user) return;
        const getRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        onSnapshot(getRef('sites'), (s) => { window.state.sites = s.docs.map(d => d.data()); window.renderView(); });
        onSnapshot(getRef('partners'), (s) => { window.state.partners = s.docs.map(d => d.data()); window.renderView(); });
        onSnapshot(getRef('logs'), (s) => { 
            window.state.logs = s.docs.map(d => d.data()).sort((a,b) => b.createdAt - a.createdAt); 
            window.renderView(); 
        });
    }

    window.renderView = () => {
        const vp = document.getElementById('viewport');
        if(!vp) return;
        vp.innerHTML = '';
        
        switch(window.state.currentView) {
            case 'dashboard': renderDashboard(vp); break;
            case 'sites': renderList(vp, 'sites', '현장'); break;
            case 'partners': renderList(vp, 'partners', '협력사'); break;
            case 'site-detail': renderSiteDetail(vp); break;
            case 'partner-detail': renderPartnerDetail(vp); break;
        }
        lucide.createIcons();
    };

    function renderDashboard(el) {
        el.innerHTML = `
            <div class="space-y-6">
                <div class="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-xs font-bold opacity-80 mb-1">오늘의 영업 활동</p>
                        <h2 class="text-3xl font-black">${window.state.logs.filter(l => l.date === new Date().toISOString().split('T')[0]).length} <span class="text-lg">건</span></h2>
                    </div>
                    <i data-lucide="trending-up" class="absolute right-[-10%] bottom-[-10%] w-32 h-32 opacity-10"></i>
                </div>

                <div class="flex justify-between items-center px-1">
                    <h3 class="font-black text-slate-800">최근 활동 타임라인</h3>
                    <button onclick="window.openAddLogModal()" class="text-xs font-black bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100">+ 로그 기록</button>
                </div>

                <div class="space-y-4 pb-10">
                    ${window.state.logs.slice(0, 10).map(l => `
                        <div onclick="window.viewLogDetail('${l.id}')" class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow active:scale-95 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-black px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg uppercase">${l.category}</span>
                                <span class="text-[10px] font-bold text-slate-400">${l.date}</span>
                            </div>
                            <h4 class="font-black text-slate-800 mb-1">${l.siteName}</h4>
                            <p class="text-xs text-slate-500 font-medium truncate">${l.content}</p>
                        </div>
                    `).join('') || '<div class="text-center py-20 text-slate-300 font-bold">활동 기록이 없습니다.</div>'}
                </div>
            </div>
        `;
    }

    function renderList(el, key, label) {
        el.innerHTML = `
            <div class="flex justify-between items-center mb-6 px-1">
                <h2 class="text-2xl font-black text-slate-800">${label} 목록</h2>
                <button onclick="window.openAddItemModal('${key}')" class="p-2 bg-indigo-600 text-white rounded-xl shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
            </div>
            <div class="grid gap-3 pb-20">
                ${window.state[key].map(item => `
                    <div onclick="window.router.push('${key.slice(0,-1)}-detail', '${item.id}')" class="bg-white p-5 rounded-[1.5rem] border border-slate-100 card-shadow flex items-center justify-between active:scale-95 transition-all">
                        <div>
                            <p class="font-black text-slate-800">${item.name}</p>
                            <p class="text-[10px] font-bold text-slate-400 mt-1">${item.addr || item.company || '정보 없음'}</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-slate-200"></i>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderSiteDetail(el) {
        const site = window.state.sites.find(s => s.id === window.state.activeId);
        if(!site) return;
        const siteLogs = window.state.logs.filter(l => l.siteName === site.name);

        el.innerHTML = `
            <div class="mb-6 flex justify-between items-center px-1">
                <button onclick="window.router.push('sites')" class="p-2 bg-white rounded-xl shadow-sm"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-black text-slate-800">현장 상세</h2>
                <button onclick="window.deleteItem('sites', '${site.id}')" class="p-2 text-rose-500 bg-white rounded-xl shadow-sm"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] card-shadow mb-6">
                <h3 class="text-2xl font-black text-slate-800 mb-2">${site.name}</h3>
                <p class="text-sm font-bold text-slate-400 flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i> ${site.addr || '주소 미등록'}</p>
                <div class="mt-6 pt-6 border-t border-slate-50">
                    <p class="text-[10px] font-black text-slate-300 uppercase mb-2">현장 특이사항</p>
                    <textarea onchange="window.updateField('sites', '${site.id}', 'memo', this.value)" class="w-full bg-slate-50 p-4 rounded-2xl text-xs font-bold min-h-[100px] border-none outline-none resize-none">${site.memo || ''}</textarea>
                </div>
            </div>

            <div class="px-1 space-y-4 pb-20">
                <h3 class="font-black text-slate-800 flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4 text-indigo-600"></i> 업무 이력
                </h3>
                ${siteLogs.map(l => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative">
                        <div class="flex justify-between mb-2">
                            <span class="text-[9px] font-black text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded">${l.category}</span>
                            <span class="text-[9px] font-bold text-slate-300">${l.date}</span>
                        </div>
                        <p class="text-xs font-bold text-slate-600 whitespace-pre-wrap">${l.content}</p>
                        ${l.drawing ? `<img src="${l.drawing}" class="mt-3 w-full h-32 object-cover rounded-xl border border-slate-50">` : ''}
                    </div>
                `).join('') || '<div class="py-10 text-center text-slate-300 font-bold text-xs">등록된 이력이 없습니다.</div>'}
            </div>
        `;
    }

    function renderPartnerDetail(el) {
        const partner = window.state.partners.find(p => p.id === window.state.activeId);
        if(!partner) return;
        const relatedSites = [...new Set(window.state.logs.filter(l => l.partnerName === partner.name).map(l => l.siteName))];

        el.innerHTML = `
            <div class="mb-6 flex justify-between items-center px-1">
                <button onclick="window.router.push('partners')" class="p-2 bg-white rounded-xl shadow-sm"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-black text-slate-800">협력사 상세</h2>
                <button onclick="window.deleteItem('partners', '${partner.id}')" class="p-2 text-rose-500 bg-white rounded-xl shadow-sm"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] card-shadow mb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">
                        ${partner.photo ? `<img src="${partner.photo}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-8 h-8 text-slate-300"></i>`}
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-slate-800">${partner.name}</h3>
                        <p class="text-xs font-bold text-indigo-600">${partner.company || '소속 미정'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-6">
                    <button onclick="window.openSketchModal('partners', '${partner.id}')" class="bg-slate-50 p-3 rounded-xl flex items-center justify-center gap-2 text-xs font-bold text-slate-600">
                        <i data-lucide="camera" class="w-4 h-4"></i> 사진/명함 등록
                    </button>
                    <a href="tel:${partner.phone}" class="bg-indigo-50 p-3 rounded-xl flex items-center justify-center gap-2 text-xs font-bold text-indigo-600">
                        <i data-lucide="phone" class="w-4 h-4"></i> 전화 걸기
                    </a>
                </div>

                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-300 uppercase ml-1">연락처</label>
                        <input type="text" onchange="window.updateField('partners', '${partner.id}', 'phone', this.value)" value="${partner.phone || ''}" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border-none outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-300 uppercase ml-1">인물 메모</label>
                        <textarea onchange="window.updateField('partners', '${partner.id}', 'memo', this.value)" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold min-h-[80px] border-none outline-none resize-none">${partner.memo || ''}</textarea>
                    </div>
                </div>
            </div>

            <div class="px-1 space-y-4 pb-20">
                <h3 class="font-black text-slate-800 flex items-center gap-2">
                    <i data-lucide="building" class="w-4 h-4 text-indigo-600"></i> 관련 현장 히스토리
                </h3>
                <div class="grid gap-2">
                    ${relatedSites.map(sn => {
                        const site = window.state.sites.find(s => s.name === sn);
                        return `
                            <div ${site ? `onclick="window.router.push('site-detail', '${site.id}')"` : ''} class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center active:bg-slate-50 transition-colors">
                                <span class="text-xs font-black text-slate-700">${sn}</span>
                                <i data-lucide="arrow-right" class="w-3 h-3 text-slate-300"></i>
                            </div>
                        `;
                    }).join('') || '<div class="py-10 text-center text-slate-300 font-bold text-xs">연결된 현장이 없습니다.</div>'}
                </div>
            </div>
        `;
    }

    // --- 스케치 & 사진 시스템 ---
    let drawingState = { isDrawing: false, ctx: null, canvas: null };

    window.openSketchModal = (col, id) => {
        window.openModal("사진/스케치 등록", `
            <div class="space-y-4">
                <div class="bg-slate-100 rounded-3xl overflow-hidden canvas-bg border-2 border-slate-200" style="height: 300px;">
                    <canvas id="sketch-canvas"></canvas>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.clearCanvas()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold text-sm">지우기</button>
                    <button onclick="window.saveSketch('${col}', '${id}')" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-lg">저장하기</button>
                </div>
            </div>
        `);
        setTimeout(initCanvas, 100);
    };

    function initCanvas() {
        const canvas = document.getElementById('sketch-canvas');
        if(!canvas) return;
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = "#4f46e5";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        drawingState = { isDrawing: false, ctx, canvas };

        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            return { x: clientX - rect.left, y: clientY - rect.top };
        };

        const start = (e) => { drawingState.isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        const draw = (e) => { if(!drawingState.isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
        const stop = () => drawingState.isDrawing = false;

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stop);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        canvas.addEventListener('touchend', stop);
    }

    window.clearCanvas = () => drawingState.ctx.clearRect(0,0, drawingState.canvas.width, drawingState.canvas.height);
    
    window.saveSketch = async (col, id) => {
        const dataUrl = drawingState.canvas.toDataURL();
        const field = col === 'partners' ? 'photo' : 'drawing';
        await window.updateField(col, id, field, dataUrl);
        window.closeModal();
        window.renderView();
    };

    // --- 공통 기능 ---
    window.openModal = (title, html) => {
        const mc = document.getElementById('modal-content');
        mc.innerHTML = `
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-black text-slate-800">${title}</h3>
                <button onclick="window.closeModal()" class="p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto no-scrollbar flex-1">${html}</div>
        `;
        document.getElementById('modal-overlay').classList.remove('hidden');
        lucide.createIcons();
    };

    window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');

    window.openAddItemModal = (key) => {
        const label = key === 'sites' ? '현장명' : '이름';
        window.openModal(`${label} 추가`, `
            <div class="space-y-4">
                <input type="text" id="add-name" placeholder="${label}을 입력하세요" class="w-full bg-slate-100 p-5 rounded-2xl font-bold border-none outline-none">
                <button onclick="window.submitItem('${key}')" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-xl">등록하기</button>
            </div>
        `);
    };

    window.submitItem = async (key) => {
        const name = document.getElementById('add-name').value.trim();
        if(!name) return;
        const id = key.slice(0,2) + "_" + Date.now();
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', key, id), { id, name, createdAt: Date.now() });
        window.closeModal();
    };

    window.openAddLogModal = () => {
        window.openModal("영업 활동 기록", `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="l-site" list="site-list" placeholder="현장선택" class="w-full bg-slate-100 p-4 rounded-xl text-xs font-bold outline-none">
                    <datalist id="site-list">${window.state.sites.map(s=>`<option value="${s.name}">`).join('')}</datalist>
                    <input type="text" id="l-part" list="part-list" placeholder="협력사선택" class="w-full bg-slate-100 p-4 rounded-xl text-xs font-bold outline-none">
                    <datalist id="part-list">${window.state.partners.map(p=>`<option value="${p.name}">`).join('')}</datalist>
                </div>
                <select id="l-cat" class="w-full bg-slate-100 p-4 rounded-xl text-xs font-bold outline-none border-none">
                    ${window.state.categories.map(c=>`<option value="${c}">${c}</option>`).join('')}
                </select>
                <textarea id="l-content" placeholder="활동 내용을 상세히 적어주세요" class="w-full bg-slate-100 p-4 rounded-xl text-xs font-bold h-32 outline-none border-none resize-none"></textarea>
                <div class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl relative overflow-hidden">
                    <canvas id="log-sketch-canvas"></canvas>
                    <button onclick="window.initLogCanvas()" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-slate-300">클릭하여 스케치 추가</button>
                </div>
                <button onclick="window.submitLog()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-xl">기록 저장</button>
            </div>
        `);
        window.initLogCanvas = () => {
            document.querySelector('#log-sketch-canvas + button').style.display = 'none';
            initCanvasById('log-sketch-canvas');
        };
    };

    function initCanvasById(id) {
        const canvas = document.getElementById(id);
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = "#4f46e5"; ctx.lineWidth = 3; ctx.lineCap = "round";
        drawingState = { isDrawing: false, ctx, canvas };
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            return { x: clientX - rect.left, y: clientY - rect.top };
        };
        const start = (e) => { drawingState.isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        const draw = (e) => { if(!drawingState.isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); }); canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        window.addEventListener('mouseup', () => drawingState.isDrawing = false);
        window.addEventListener('touchend', () => drawingState.isDrawing = false);
    }

    window.submitLog = async () => {
        const siteName = document.getElementById('l-site').value;
        const content = document.getElementById('l-content').value;
        if(!siteName || !content) return;
        const id = "log_" + Date.now();
        const drawing = drawingState.canvas ? drawingState.canvas.toDataURL() : null;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', id), {
            id, siteName, partnerName: document.getElementById('l-part').value,
            category: document.getElementById('l-cat').value, content,
            drawing: (drawing && drawing.length > 2000) ? drawing : null,
            date: new Date().toISOString().split('T')[0], createdAt: Date.now()
        });
        window.closeModal();
    };

    window.updateField = async (col, id, field, val) => {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), { [field]: val });
    };

    window.deleteItem = async (col, id) => {
        if(!confirm("삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.")) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
        window.router.push(col);
    };

    // --- Gemini AI 통합 ---
    window.askGeminiModal = () => {
        window.openModal("AI 영업 전략 제언", `
            <div class="space-y-4">
                <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
                    <p class="text-xs font-bold text-indigo-700 leading-relaxed" id="ai-response">
                        데이터를 분석하여 최적의 영업 시나리오를 생성하고 있습니다...
                    </p>
                </div>
                <button onclick="window.closeModal()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold">확인</button>
            </div>
        `);
        generateAIStrategy();
    };

    async function generateAIStrategy() {
        const dataSummary = `현장목록: ${window.state.sites.map(s=>s.name).join(',')}, 로그요약: ${window.state.logs.slice(0,5).map(l=>l.content).join('/')}`;
        const prompt = `당신은 건설 전문 영업 컨설턴트입니다. 다음 영업 데이터를 바탕으로 오늘 가장 먼저 방문해야 할 현장 1곳과 대응 전략을 한국어 3줄로 제안하세요. 데이터: ${dataSummary}`;
        
        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const result = await resp.json();
            document.getElementById('ai-response').innerText = result.candidates[0].content.parts[0].text;
        } catch (e) {
            document.getElementById('ai-response').innerText = "분석 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
        }
    }

    onAuthStateChanged(auth, (u) => { if (u) { window.state.user = u; initDataSync(); } else { initAuth(); } });
</script>
</body>
</html>
